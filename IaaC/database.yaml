AWSTemplateFormatVersion: '2010-09-09'
Description: 'Database infrastructure - RDS from snapshot'

Parameters:
  Environment:
    Type: String
  VPCId:
    Type: String
  PrivateSubnets:
    Type: CommaDelimitedList
  DBSnapshotId:
    Type: String

Resources:
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS database
      SubnetIds: !Ref PrivateSubnets
      Tags:
        - Key: Name
          Value: !Sub "${Environment}-db-subnet-group"

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS database
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.0.0.0/16
      Tags:
        - Key: Name
          Value: !Sub "${Environment}-db-sg"

  DatabaseInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBSnapshotIdentifier: !Ref DBSnapshotId
      DBInstanceIdentifier: !Sub "${Environment}-database"
      DBInstanceClass: db.t3.micro
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      MultiAZ: false
      StorageEncrypted: true
      BackupRetentionPeriod: 7
      PreferredBackupWindow: "03:00-04:00"
      PreferredMaintenanceWindow: "sun:04:00-sun:05:00"
      Tags:
        - Key: Name
          Value: !Sub "${Environment}-database"

Outputs:
  DatabaseEndpoint:
    Value: !GetAtt DatabaseInstance.Endpoint.Address
    Export:
      Name: !Sub "${Environment}-DatabaseEndpoint"

  DatabasePort:
    Value: !GetAtt DatabaseInstance.Endpoint.Port
    Export:
      Name: !Sub "${Environment}-DatabasePort"
